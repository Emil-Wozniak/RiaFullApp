package org.ria.ifzz.RiaApp.service;

import org.ria.ifzz.RiaApp.domain.*;
import org.ria.ifzz.RiaApp.repository.ControlCurveRepository;
import org.ria.ifzz.RiaApp.utils.*;
import org.springframework.web.bind.annotation.RestController;

import javax.validation.constraints.NotNull;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import static org.ria.ifzz.RiaApp.domain.HormonesPattern.CORTISOL_PATTERN;

@RestController
public class ResultService {

    private final CustomFileReader customFileReader;
    private final CountResultUtil countResultUtil;
    private final FileUtils fileUtils;
    private final ControlCurveRepository controlCurveRepository;
    private final ControlCurveService controlCurveService;
    private final DataAssigner dataAssigner;

    public ResultService(CustomFileReader customFileReader, CountResultUtil countResultUtil, FileUtils fileUtils, ControlCurveRepository controlCurveRepository, ControlCurveService controlCurveService, DataAssigner dataAssigner) {
        this.customFileReader = customFileReader;
        this.countResultUtil = countResultUtil;
        this.fileUtils = fileUtils;
        this.controlCurveRepository = controlCurveRepository;
        this.controlCurveService = controlCurveService;
        this.dataAssigner = dataAssigner;
    }

    /**
     * takes file store in local disc space
     *
     * @param model data from uploaded file
     * @return expected List of Strings
     * @throws IOException
     */
    public List<String> getFileData(FileModel model) throws IOException {
        System.out.println(customFileReader.getUploadComment());
        List<String> streamRead = customFileReader.readFromStream(model);
        return streamRead;
    }

    /**
     * takes fileName of upload file and set specific id for each entities
     * reads given Strings List and create Result entity for each lines of given,
     *
     * @param fileData pre-cleaned list
     * @param file
     * @return Result entities
     */
    public List<Result> setResultFromColumnsLength(List<String> fileData,
                                                   @NotNull FileModel file,
                                                   Backlog backlog) {

        Result result = new Result();
        List<Result> results = new ArrayList<>();
        for (String line : fileData) {
            if (line.startsWith(" \tUnk")) {
                result = new Result();
                result.setFileName(fileData.indexOf(line) + "_" + fileUtils.setFileName(file));
                result.setBacklog(backlog);
                results.add(result);
            }
        }
        return results;
    }

    /**
     * find Result entity in database by {@code}fileName_index,
     * which is created by file's fileName + _ + index, and
     * then assign results from "CCMP" table
     *
     * @param fileDataList generated by upload file
     */
    public List<Result> assignDataToResult(List<String> fileDataList, FileEntity fileEntity, List<Result> results) {
        String fileId = fileEntity.getDataId();
        List<Result> resultsWithData;
        List<Result> resultList = new ArrayList<>();

        resultsWithData = dataAssigner.setCpm(fileDataList, results);
        for (int i = 0; i < resultsWithData.size(); i++) {
            Result result = resultsWithData.get(i);
            resultList.add(result);
        }
        resultsWithData = dataAssigner.setPosition(fileDataList, results);
        for (int i = 0; i < resultsWithData.size(); i++) {
            Result result = resultsWithData.get(i);
            resultList.add(result);
        }
        resultsWithData = dataAssigner.setSamples(fileDataList, fileId, results);
        for (int i = 0; i < resultsWithData.size(); i++) {
            Result result = resultsWithData.get(i);
            resultList.add(result);
        }
        System.out.println("resultsWithData size: " + resultList.size());
        return resultList;
    }

    /**
     * @param fileData             contains data which will be assign to Result
     * @param controlCurveList curve points
     * @param results          list of the Result entities with assigned data
     * @return list of Result entities with calculated mass of the hormone in nanograms
     */
    public List<Result> assignNgPerMl(List<String> fileData, List<ControlCurve> controlCurveList, List<Result> results) {

        List<Double> curve = new ArrayList<>();
        setStandardPattern(fileData);
        List<Point> points = setControlPointsFromControlCurve(controlCurveList, curve);
        countResultUtil.setControlCurveCpmWithFlag(points);
        countResultUtil.setStandardsCpmWithFlags(points);
        countResultUtil.bindingPercent();
        countResultUtil.logarithmRealZero();
        countResultUtil.countRegressionParameterB();
        countResultUtil.countRegressionParameterA();
        return getCountedResults(fileData, results);
    }

    @org.jetbrains.annotations.NotNull
    private List<Result> getCountedResults(List<String> list, List<Result> results) {
        Result result;
        List<Result> countedResults = new ArrayList<>();
        for (int i = 25; i < list.size(); i++) {
            result = results.get(i);
            double point = result.getCcpm();
            System.out.println("Point CPM: " + point);
            double counted = countResultUtil.countResult(point);
            if (Double.isNaN(counted)) {
                counted = 0.0;
            }
            result.setNg(counted);
            countedResults.add(result);
        }
        return countedResults;
    }

    private List<Point> setControlPointsFromControlCurve(List<ControlCurve> controlCurveList,
                                                         List<Double> curve) {
        List<Point> points = new ArrayList<>();
        ControlCurve controlCurve;

        //set cpm values to control curve points
        for (int i = 0; i < 24; i++) {
            controlCurve = controlCurveList.get(i);
            Double pointValue = controlCurve.getCcpm();
            Boolean flag = controlCurve.isFlagged();
            curve.add(pointValue);
            Point point = new Point(pointValue, flag);
            points.add(point);
        }
        return points;
    }

    private void setStandardPattern(List<String> fileData) {
        // get standard pattern
        System.out.println("Pattern detected:");
        if (fileData.get(0).equals("KORTYZOL_5_MIN")) {
            System.out.println(fileData.get(0));
            countResultUtil.logDose(CORTISOL_PATTERN);
        }
    }

    //TODO handle that file has less than 26 points
    public List<Result> setDataToResult(@NotNull FileModel file, List<String> fileData, Backlog backlog, FileEntity fileEntity) {

        List<Result> resultsWithData = new ArrayList<>();
        List<Result> resultListWithNg = new ArrayList<>();
        List<Result> results = setResultFromColumnsLength(fileData, file, backlog);
        if (fileData.size() > 24) {
            try {
                resultsWithData = assignDataToResult(fileData, fileEntity, results);
            } catch (Exception e) {
                System.out.println("Assign Data To Result: " + e.getMessage() + " | " + e.getCause());
            }
        }
        List<ControlCurve> controlCurveList = controlCurveService.setControlCurveFromColumnsLength(fileData, file, backlog);
        List<ControlCurve> controlCurveListWithData = controlCurveService.setDataToControlCurve(fileData, fileEntity, controlCurveList);

        //Check if any of standard points are above Zeros points
        if (isStandardCpmAboveZero(controlCurveListWithData)) {
            controlCurveRepository.saveAll(controlCurveListWithData);
            return resultsWithData;
        }
        //is they aren't ng will be set to results
        else {
            controlCurveRepository.saveAll(controlCurveListWithData);
            try {
                resultListWithNg = assignNgPerMl(fileData, controlCurveListWithData, resultsWithData);
            } catch (Exception e) {
                System.out.println("Exception ng: " + e.getMessage() + " with cause: " + e.getCause());
            }
            return resultListWithNg;
        }
    }

    private boolean isStandardCpmAboveZero(List<ControlCurve> list) {
        boolean checker = false;
        boolean isAbove;
        for (int i = 8; i < 21; i++) {
            ControlCurve controlCurve = list.get(i);
            if (controlCurve.isFlagged()) {
                checker = true;
                System.out.println("Standard Cpm are above zero");
            }
        }
        isAbove = checker;
        System.out.println("isAbove: " + isAbove);
        return isAbove;
    }
}

